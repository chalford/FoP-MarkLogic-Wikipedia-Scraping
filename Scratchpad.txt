declare function SaveImagesToDatabase($content)
{
	let $images := GetImagesFromPage($content)
	let $_ := xdmp:log(fn:concat("Going to download the following images [", $images, "]"))
	return
		for $image in $images
		let $filename := functx:substring-after-last($image, "/")
		return
			xdmp:document-load
				(
					$image,
					<options xmlns="xdmp:document-load">
						<uri>$filename</uri>
					</options>
				)
};


declare function SaveImagesToDatabase($content)
{
	let $insertCommand := fn:concat
		("
			declare variable $urlExt external;
			declare variable $filenameExt external;
			xdmp:document-load
				(
					$urlExt,
					<options xmlns="xdmp:document-load">
						<uri>$filenameExt</uri>
					</options>
				)
		")
		
	let $images := GetImagesFromPage($content)
	let $_ := xdmp:log(fn:concat("Going to download the following images [", $images, "]"))
	return
		for $image in $images
		let $filename := functx:substring-after-last($image, "/")
		return
			xdmp:eval
			(
				$insertCommand,
				(
					xs:QName("urlExt"), $image,
					xs:QName("filenameExt"), $filename
				),
				<options xmlns="xdmp:eval">
					<isolation>different-transaction</isolation>
					<prevent-deadlocks>true</prevent-deadlocks>
				</options>
			)
			
};

declare function SaveImagesToDatabase($content)
{
	let $insertCommand := fn:concat
		(
			'declare variable $urlExt external;',
			'declare variable $filenameExt external;',
			'xdmp:document-load(',
				'$urlExt',
				',',
				'<options xmlns="xdmp:document-load">',
					'<uri>',
						'$filenameExt',
					'</uri>',
				'</options>',
				')'
		)
		
	let $images := GetImagesFromPage($content)
	return
		for $image in $images
		let $_ := xdmp:log(fn:concat("Going to download the following image [", $image, "]"))
		let $filename := functx:substring-after-last($image, "/")
		return
			let $eval := xdmp:eval
			(
				$insertCommand,
				(
					xs:QName("urlExt"), $image,
					xs:QName("filenameExt"), $filename
				),
				<options xmlns="xdmp:eval">
					<isolation>different-transaction</isolation>
					<prevent-deadlocks>true</prevent-deadlocks>
				</options>
			)
			let $_ := xdmp:log($eval)
			return
				()
			
};